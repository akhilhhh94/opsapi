---
# tasks file for roles/varnish_cache
- name: Check if Nginx is installed
  ansible.builtin.command: which nginx
  register: nginx_installed
  changed_when: false
  ignore_errors: true
  tags: varnish_cache
- name: Fail if Nginx is not installed
  ansible.builtin.fail:
    msg: "Nginx is not installed on the target machine."
  when: nginx_installed.rc != 0
# task fot sudo apt-get update
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  become_user: root
  tags: varnish_cache
- name: Add varnishcache repository
  ansible.builtin.shell: curl -s https://packagecloud.io/install/repositories/varnishcache/varnish{{ varnish_cache_version | replace(".", "") }}/script.deb.sh | sudo bash
  become: true
  become_user: root
  tags: varnish_cache
  changed_when: false
  # Add varnishcache preferences
- name: Add varnishcache preferences
  ansible.builtin.shell: |
    sudo tee /etc/apt/preferences.d/varnishcache > /dev/null <<-EOF
    Package: varnish varnish-*
    Pin: release o=packagecloud.io/varnishcache/*
    Pin-Priority: 1000
    EOF
  become: true
  become_user: root
  tags: varnish_cache
  changed_when: false
- name: Install varnish {{ varnish_cache_version }}
  ansible.builtin.apt:
    name: varnish
    state: present
  become: true
  become_user: root
  tags: varnish_cache
  changed_when: false
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  become_user: root
  tags: varnish_cache

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  become_user: root
  tags: varnish_cache


- name: Copy varnish.service to /etc/systemd/system/varnish.service
  ansible.builtin.template:
    src: roles/varnish_cache/templates/varnish.service
    dest: /etc/systemd/system/varnish.service
    owner: root
    group: root
    mode: 0644
  become: true
  become_user: root
  tags: varnish_cache
  # ensure copy above step (/etc/systemd/system/varnish.service)
  # is done before this step


- name: Copy default.vcl to /etc/varnish/default.vcl
  ansible.builtin.template:
    src: roles/varnish_cache/templates/default.vcl
    dest: /etc/varnish/default.vcl
    owner: root
    group: root
    mode: 0644
  become: true
  become_user: root
  tags: varnish_cache


- name: Change nginx listening port
  ansible.builtin.shell: |
    find /etc/nginx -name '*.conf' -exec sed -r -i 's/\blisten ([^:]+:)?{{ varnish_cache_listening_port }}\b([^;]*);/listen \1{{ varnish_cache_existing_webserver_vcl_port }}\2;/g' {} ';'
    sudo find /etc/nginx/sites-available -type f -exec sed -r -i 's/\blisten ([^:]+:)?{{ varnish_cache_listening_port }}\b([^;]*);/listen \1{{ varnish_cache_existing_webserver_vcl_port }}\2;/g' {} \;
    sudo find /etc/nginx/sites-available -type f -exec sed -r -i 's/\blisten (\[::\]:)?{{ varnish_cache_listening_port }}\b([^;]*);/listen \1{{ varnish_cache_existing_webserver_vcl_port }}\2;/g' {} \;
  become: true
  become_user: root
  tags: varnish_cache
- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  become_user: root
  tags: varnish_cache

- name: Restart nginx
  ansible.builtin.systemd:
    name: nginx
    state: restarted
  tags: varnish_cache

- name: Enable varnish
  ansible.builtin.systemd:
    name: varnish
    enabled: true
  become: true
  become_user: root
  tags: varnish_cache

- name: Restart varnish
  ansible.builtin.systemd:
    name: varnish
    state: restarted
  become: true
  become_user: root
  tags: varnish_cache

- name: Check varnish status
  ansible.builtin.systemd:
    name: varnish
    state: started
  become: true
  become_user: root
  tags: varnish_cache
- name: Install rsync on the remote machine
  ansible.builtin.package:
    name: rsync
    state: present
  become: true
  become_user: root
  tags: varnish_cache, sync_files

- name: Synchronize files to the remote machine
  ansible.posix.synchronize:
    src: "{{ varnish_cache_additional_conf_files }}"
    dest: /etc/varnish/
  become: true
  register: sync_files
  become_user: root
  when: varnish_cache_additional_conf_files is defined
  tags: varnish_cache, sync_files

- name: Debug synchronized files
  ansible.builtin.debug:
    var: sync_files
  tags: varnish_cache, sync_files
- name: Find all VCL files in the directory
  ansible.builtin.find:
    paths: /etc/varnish/
    patterns: '*.vcl'
    exclude: default.vcl
  register: vcl_files
  tags: varnish_cache, sync_files

- name: Load each VCL file using varnishadm
  ansible.builtin.shell: |
    varnishadm vcl.load {{ item.path | basename | replace('.vcl', '') }} {{ item.path }}
    varnishadm vcl.use {{ item.path | basename | replace('.vcl', '') }}
  loop: "{{ vcl_files.files }}"
  when: vcl_files.matched > 0
  become: true
  become_user: root
  tags: varnish_cache, sync_files

- name: List and debug all loaded VCL files in Varnish Cache
  ansible.builtin.shell: varnishadm vcl.list
  become: true
  become_user: root
  tags: varnish_cache, sync_files
  register: vcl_list
- name: Debug VCL list
  ansible.builtin.debug:
    var: vcl_list
  tags: varnish_cache, sync_files


